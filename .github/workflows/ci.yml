name: Apex CI/CD Pipeline

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]

jobs:
  # --------------------------------------------------------------
  # 1. BUILD & LINT (For Jupyter/Python Artifacts)
  # --------------------------------------------------------------
  build_and_lint:
    name: Build, Lint & Format Check
    runs-on: ubuntu-latest
    defaults:
      run:
        shell: bash

    steps:
      - name: üöÄ Checkout Repository
        uses: actions/checkout@v4

      - name: üêç Setup Python Environment (3.11)
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install Apex Dependency Resolver (uv)
        run: pip install uv

      - name: Install Project Dependencies (via uv)
        run: | 
          # Assuming dependencies are listed in requirements.txt for this ML repo
          uv pip install --system -r requirements.txt

      - name: Install Linter/Formatter (Ruff)
        run: uv pip install ruff

      - name: ‚úÖ Run Ruff Linter & Formatter Check (Zero Tolerance)
        run: ruff check . --config pyproject.toml

      - name: ‚úÖ Verify Notebook Syntax (Jupyter Tools)
        # Since this is a Jupyter Notebook project, we check syntax integrity.
        # In a real scenario, papermill or nbqa would be used for functional testing.
        run: | 
          pip install nbqa
          nbqa black . --check
          nbqa isort . --check

      - name: Archive Artifacts (Notebooks)
        uses: actions/upload-artifact@v4
        with:
          name: source-notebooks
          path: '**/*.ipynb'

  # --------------------------------------------------------------
  # 2. TESTING (If a test suite existed, it would run here. 
  # For notebooks, often this is skipped or uses specialized tools like pytest-nb.)
  # --------------------------------------------------------------
  test_suite:
    name: Run Pytest Suite
    runs-on: ubuntu-latest
    needs: [build_and_lint]
    defaults:
      run:
        shell: bash

    steps:
      - name: ‚¨áÔ∏è Download Source Artifacts
        uses: actions/download-artifact@v4
        with:
          name: source-notebooks

      - name: üêç Setup Python Environment (3.11)
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install Apex Dependency Resolver (uv)
        run: pip install uv

      - name: Install Test Dependencies
        run: | 
          # Install Pytest and necessary notebook testing libraries
          uv pip install --system pytest pytest-cov nbqa
          uv pip install --system -r requirements-dev.txt || echo "Skipping dev requirements install if missing"

      - name: Execute Pytest with Coverage
        # Note: For notebook testing, nbqa handles execution and validation against cell outputs
        run: | 
          pytest --verbose
        continue-on-error: true # Notebook execution can sometimes fail transiently, allowing build to proceed if linting passed.

      - name: Report Coverage (Placeholder for Codecov integration)
        # Assuming coverage reports are generated via pytest-cov
        uses: codecov/codecov-action@v4
        with:
          token: ${{ secrets.CODECOV_TOKEN }}
          files: ./coverage.xml
          name: codecov-umbrella
          fail_ci_if_error: false
          
  # --------------------------------------------------------------
  # 3. MODEL INTEGRITY CHECK (Specific to Image Generation Repos)
  # --------------------------------------------------------------
  model_check:
    name: Validate Model Card & Weights
    runs-on: ubuntu-latest
    needs: [build_and_lint]

    steps:
      - name: üöÄ Checkout Repository
        uses: actions/checkout@v4

      - name: Check for Required Files
        run: |
          if [ ! -f "model_card.md" ]; then
            echo "::error::Model Card (model_card.md) not found. CRITICAL FAILURE."::set-output name=model_status::FAIL
          else
            echo "::notice::Model Card verified."::set-output name=model_status::PASS
          fi

          if [ ! -f "model_weights/sd_v2.safetensors" ]; then
            echo "::warning::Stable Diffusion weights file not detected in standard path. Assuming remote loading."
          else
            echo "::notice::Local weights detected."
          fi

      - name: Final Status Report
        run: echo "Model Integrity Check Complete."